*--------------------------------------------------------------------------------------------------------------------------------------------------------
* (ES) AUTOGENERADO - ¡¡ATENCIÓN!! - ¡¡NO PENSADO PARA EJECUTAR!! USAR SOLAMENTE PARA INTEGRAR CAMBIOS Y ALMACENAR CON HERRAMIENTAS SCM!!
* (EN) AUTOGENERATED - ATTENTION!! - NOT INTENDED FOR EXECUTION!! USE ONLY FOR MERGING CHANGES AND STORING WITH SCM TOOLS!!
*--------------------------------------------------------------------------------------------------------------------------------------------------------
*< FOXBIN2PRG: Version="1.19" SourceFile="sas_facturar.scx" /> (Solo para binarios VFP 9 / Only for VFP 9 binaries)
*
*
#INCLUDE "..\include\tastrade.h"

DEFINE CLASS dataenvironment AS dataenvironment 
 	*< CLASSDATA: Baseclass="dataenvironment" Timestamp="" Scale="" Uniqueid="" ClassIcon="1" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="Cursor1" UniqueID="" Timestamp="" />

	DataSource = .NULL.
	Height = 200
	Left = 542
	Name = "Dataenvironment"
	Top = 136
	Width = 520

	ADD OBJECT 'Cursor1' AS cursor WITH ;
		Alias = "sas_ctiposeguro", ;
		CursorSource = "sas_ctiposeguro", ;
		Database = ..\data\datos.dbc, ;
		Height = 90, ;
		Left = 10, ;
		Name = "Cursor1", ;
		NoDataOnLoad = .T., ;
		Top = 20, ;
		Width = 126
		*< END OBJECT: BaseClass="cursor" />

ENDDEFINE

DEFINE CLASS tsbaseform12 AS tsbaseform OF "..\libs\tsbase.vcx" 
 	*< CLASSDATA: Baseclass="form" Timestamp="" Scale="" Uniqueid="" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="Tslabel1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tstextbox1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tscommandbutton1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Idproducto1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tslabel2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Producto" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tscommandbutton2" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tscombobox3" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tslabel3" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro.Column1.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro.Column1.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro.Column2.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro.Column2.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro.Column4.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro.Column4.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro.Column3.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grdSas_ctiposeguro.Column3.Tscheckbox1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tslabel4" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="dFecha" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="lblIdseguro" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tslabel5" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="hFecha" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tipo" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Tslabel6" UniqueID="" Timestamp="" />

	Caption = "Factura Servicio"
	DataSession = 1
	detalle = .T.
	DoCreate = .T.
	editmode = .T.
	Height = 454
	idobjeto = 1184
	Name = "Tsbaseform12"
	Width = 633
	lblRequerido.Name = "lblRequerido"
	lblRequerido.TabIndex = 11

	ADD OBJECT 'dFecha' AS tstextbox WITH ;
		Alignment = 3, ;
		Left = 144, ;
		Name = "dFecha", ;
		TabIndex = 5, ;
		Top = 133, ;
		Value = ({  /  /  })
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="textbox" />

	ADD OBJECT 'grdSas_ctiposeguro' AS tsgrid WITH ;
		ColumnCount = 4, ;
		FontSize = 8, ;
		Height = 200, ;
		Left = 84, ;
		Name = "grdSas_ctiposeguro", ;
		Panel = 1, ;
		ReadOnly = .F., ;
		RecordSource = "sas_ctiposeguro", ;
		RecordSourceType = 1, ;
		RowHeight = 17, ;
		TabIndex = 9, ;
		titulo = Lista de Clientes, ;
		Top = 211, ;
		Width = 465, ;
		Column1.ControlSource = "sas_ctiposeguro.idtiposeguro", ;
		Column1.FontSize = 8, ;
		Column1.Name = "Column1", ;
		Column1.ReadOnly = .T., ;
		Column1.Visible = .T., ;
		Column1.Width = 57, ;
		Column2.ControlSource = "sas_ctiposeguro.tiposeguro", ;
		Column2.FontSize = 8, ;
		Column2.Name = "Column2", ;
		Column2.ReadOnly = .T., ;
		Column2.Visible = .T., ;
		Column2.Width = 232, ;
		Column3.ControlSource = "sas_ctiposeguro.monto", ;
		Column3.FontSize = 8, ;
		Column3.InputMask = "999,999,999", ;
		Column3.Name = "Column4", ;
		Column3.ReadOnly = .T., ;
		Column3.Visible = .T., ;
		Column3.Width = 102, ;
		Column4.ControlSource = "sas_ctiposeguro.generar", ;
		Column4.FontSize = 8, ;
		Column4.Name = "Column3", ;
		Column4.ReadOnly = .F., ;
		Column4.Sparse = .F., ;
		Column4.Visible = .T., ;
		Column4.Width = 47
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="grid" />

	ADD OBJECT 'grdSas_ctiposeguro.Column1.Header1' AS header WITH ;
		Caption = "Codigo", ;
		FontSize = 8, ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grdSas_ctiposeguro.Column1.Text1' AS textbox WITH ;
		BackColor = 255,255,255, ;
		BorderStyle = 0, ;
		FontSize = 8, ;
		ForeColor = 0,0,0, ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .T., ;
		SelectedBackColor = 247,223,187, ;
		SelectedForeColor = 0,64,128, ;
		Visible = .T.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'grdSas_ctiposeguro.Column2.Header1' AS header WITH ;
		Caption = "Nombre", ;
		FontSize = 8, ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grdSas_ctiposeguro.Column2.Text1' AS textbox WITH ;
		BackColor = 255,255,255, ;
		BorderStyle = 0, ;
		FontSize = 8, ;
		ForeColor = 0,0,0, ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .T., ;
		SelectedBackColor = 247,223,187, ;
		SelectedForeColor = 0,64,128, ;
		Visible = .T.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'grdSas_ctiposeguro.Column3.Header1' AS header WITH ;
		Caption = "Generar", ;
		FontSize = 8, ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grdSas_ctiposeguro.Column3.Tscheckbox1' AS tscheckbox WITH ;
		Alignment = 0, ;
		Caption = "", ;
		Left = 32, ;
		Name = "Tscheckbox1", ;
		ReadOnly = .F., ;
		Top = 23
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="checkbox" />

	ADD OBJECT 'grdSas_ctiposeguro.Column4.Header1' AS header WITH ;
		Caption = "Monto", ;
		FontSize = 8, ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grdSas_ctiposeguro.Column4.Text1' AS textbox WITH ;
		BackColor = 255,255,255, ;
		BorderStyle = 0, ;
		FontSize = 8, ;
		ForeColor = 0,0,0, ;
		InputMask = "999,999,999", ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .T., ;
		SelectedBackColor = 247,223,187, ;
		SelectedForeColor = 0,64,128, ;
		Visible = .T.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'hFecha' AS tstextbox WITH ;
		Alignment = 3, ;
		Left = 372, ;
		Name = "hFecha", ;
		TabIndex = 6, ;
		Top = 133, ;
		Value = ({  /  /  })
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="textbox" />

	ADD OBJECT 'Idproducto1' AS idproducto WITH ;
		Left = 144, ;
		Name = "Idproducto1", ;
		objeto = this.parent.Producto, ;
		TabIndex = 2, ;
		Top = 60
		*< END OBJECT: ClassLib="..\libs\futura.vcx" BaseClass="textbox" />

	ADD OBJECT 'lblIdseguro' AS tslabel WITH ;
		Caption = "Seguro", ;
		Height = 16, ;
		Left = 85, ;
		Name = "lblIdseguro", ;
		TabIndex = 18, ;
		Top = 113, ;
		Width = 52, ;
		ZOrderSet = 14
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="label" />

	ADD OBJECT 'Producto' AS tstextbox WITH ;
		Height = 21, ;
		Left = 144, ;
		MaxLength = 200, ;
		Name = "Producto", ;
		TabIndex = 3, ;
		Top = 86, ;
		Width = 408
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="textbox" />

	ADD OBJECT 'Tipo' AS tsoptiongroup WITH ;
		Height = 24, ;
		Left = 144, ;
		Name = "Tipo", ;
		TabIndex = 7, ;
		Top = 154, ;
		Width = 156, ;
		Option1.Caption = "Fijos", ;
		Option1.Left = 5, ;
		Option1.Name = "Option1", ;
		Option1.Top = 5, ;
		Option2.Caption = "Variables", ;
		Option2.Left = 73, ;
		Option2.Name = "Option2", ;
		Option2.Top = 6
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="optiongroup" />

	ADD OBJECT 'Tscombobox3' AS tscombobox WITH ;
		BoundColumn = 2, ;
		cmdsql = Select RazonSocial,IdSeguro from sas_Seguro order by 1, ;
		ControlSource = "", ;
		cursor = cSeguros, ;
		Height = 22, ;
		Left = 144, ;
		Name = "Tscombobox3", ;
		requerido = .F., ;
		TabIndex = 4, ;
		Top = 109, ;
		Width = 408, ;
		ZOrderSet = 28
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="combobox" />

	ADD OBJECT 'Tscommandbutton1' AS tscommandbutton WITH ;
		Caption = "Buscar", ;
		Left = 144, ;
		Name = "Tscommandbutton1", ;
		TabIndex = 8, ;
		Top = 180
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'Tscommandbutton2' AS tscommandbutton WITH ;
		Caption = "Generar Factura", ;
		Height = 26, ;
		Left = 144, ;
		Name = "Tscommandbutton2", ;
		TabIndex = 10, ;
		Top = 420, ;
		Width = 120
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'Tslabel1' AS tslabel WITH ;
		Caption = "Fecha", ;
		Left = 60, ;
		Name = "Tslabel1", ;
		TabIndex = 15, ;
		Top = 36
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="label" />

	ADD OBJECT 'Tslabel2' AS tslabel WITH ;
		Caption = "Producto o Servicio", ;
		Height = 22, ;
		Left = 29, ;
		Name = "Tslabel2", ;
		TabIndex = 17, ;
		Top = 60, ;
		Width = 108
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="label" />

	ADD OBJECT 'Tslabel3' AS tslabel WITH ;
		Caption = "Descripcion", ;
		Height = 22, ;
		Left = 24, ;
		Name = "Tslabel3", ;
		TabIndex = 16, ;
		Top = 86, ;
		Width = 108
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="label" />

	ADD OBJECT 'Tslabel4' AS tslabel WITH ;
		Caption = "Periodo del Servicio", ;
		Height = 22, ;
		Left = 24, ;
		Name = "Tslabel4", ;
		TabIndex = 14, ;
		Top = 133, ;
		Width = 113
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="label" />

	ADD OBJECT 'Tslabel5' AS tslabel WITH ;
		Caption = "Hasta", ;
		Height = 22, ;
		Left = 252, ;
		Name = "Tslabel5", ;
		TabIndex = 12, ;
		Top = 133, ;
		Width = 113
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="label" />

	ADD OBJECT 'Tslabel6' AS tslabel WITH ;
		Caption = "Tipo de Servicio", ;
		Height = 22, ;
		Left = 24, ;
		Name = "Tslabel6", ;
		TabIndex = 13, ;
		Top = 156, ;
		Width = 113
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="label" />

	ADD OBJECT 'Tstextbox1' AS tstextbox WITH ;
		Alignment = 3, ;
		Left = 144, ;
		Name = "Tstextbox1", ;
		TabIndex = 1, ;
		Top = 36, ;
		Value = ({  /  /  })
		*< END OBJECT: ClassLib="..\libs\tsbase.vcx" BaseClass="textbox" />
	
	PROCEDURE imprimir
		LPARAMETERS lcIdFactura
		M.IDFACTURA = lcIdFactura 
		
		
		*Verificamos la forma de imprimir la factura
		*Si tiene nombre formato, se usa el report
		*Si no tiene, se usa ASCII
		=THIS.RUNSQL("Select convert(CHAR(50),dbo.LeerConstante(?oApp.Empresa,'VT_NOMBREFORMATO_FACT')) as NombreFormato", 'cTipo')
		IF RECCOUNT('cTipo')=0
		 MESSAGEBOX("No se encuentra la constante VT_NOMBREFORMATO_FACT")
			RETURN
		ENDIF
		
		IF !EMPTY(NVL(cTipo.NombreFormato,''))
			cTipoImpresion='R'		&&Report
		ELSE
			cTipoImpresion='A'		&&Ascii
		ENDIF
		
		
			IF cTipoImpresion='A'
				=THIS.RUNSQL("Select convert(int,dbo.LeerConstante(?oApp.Empresa,'VT_IDFORMATOTPV')) as IdFormato", 'cConfig')
				IF RECCOUNT('cConfig')=0
				 MESSAGEBOX("No se encuentra la constante VT_IDFORMATOTPV")
					RETURN
				ENDIF
					=ImpresionFactura(cConfig.Idformato)
			ELSE
				LCDESTINO = LEERINI('Destino Impresion', 'OPCIONES')
				If Empty(LCDESTINO)
					LCDESTINO = 'PREVIEW NOCONSOLE'
					= ESCRIBIRINI(LCDESTINO, 'Destino Impresion', 'OPCIONES')
				Endif
		
				REPORT FORM (cTipo.NombreFormato)  &LCDESTINO 
			ENDIF
							
	ENDPROC

	PROCEDURE Tscommandbutton1.Click
		m.Idseguro = ThisForm.Tscombobox3.Value
		
		TABLEREVERT(.t.,'sas_cTipoSeguro')
		IF ThisForm.Tipo.Value=1
			=REQUERY('sas_cTipoSeguro')
		ELSE
			TEXT TO cmdSQL noshow
					SELECT     sg.idSeguro, sg.razonsocial, SUM(c.Precio) AS Importe
		FROM         sas_Seguro AS sg INNER JOIN
		                      sas_CostoServicio AS c ON sg.idSeguro = c.IdSeguro INNER JOIN
		                      sas_SolicitudServ AS s ON sg.idSeguro = s.idSeguro RIGHT OUTER JOIN
		                      sas_Tiposervicios AS ts ON s.idTipoServicio = ts.idtiposervicio AND s.IdEmpresa = ts.idEmpresa AND c.IdEmpresa = ts.idEmpresa AND 
		                      c.IdTipoServicio = ts.idtiposervicio LEFT OUTER JOIN
		                      sas_DespachoServ AS d ON s.idSolicitud = d.idSolicitud AND c.IdTipoServicio = ISNULL(d.IdTipoServicioFinal, s.idTipoServicio)
		                      where s.IdSeguro = ?m.IdSeguro
		                      and convert(datetime,CONVERT(VARCHAR (10),s.fechaAgenda,105)) between ?ThisForm.dFecha.Value and ?ThisForm.hFecha.value
						GROUP BY sg.idSeguro, sg.razonsocial
			ENDTEXT
		thisform.runsql(cmdSQL,'cServicios')
		
		INSERT INTO sas_cTipoSeguro(IdtipoSeguro,TipoSeguro,Monto,Generar);
		select IdSeguro,RazonSocial,Importe,.t. FROM cServicios
		
		ENDIF
			
			
		ThisForm.grdSas_ctiposeguro.Refresh()
		
	ENDPROC

	PROCEDURE Tscommandbutton2.Click
		SELECT sas_cTipoSeguro
		IF EMPTY(ThisForm.Tstextbox1.Value)
			MESSAGEBOX("Indique la fecha de la factura",64,TASTRADE_LOC)
			RETURN 
		ENDIF
		IF EMPTY(ThisForm.IDproducto1.Value)
			MESSAGEBOX("Indique el producto a facturar",64,TASTRADE_LOC)
			RETURN 
		ENDIF
		
			
		
		SCAN FOR !EMPTY(NVL(monto,0)) AND generar=.t.
			thisform.runsql("exec [sas_FacturaServicio] ?oApp.Empresa, ?IdTipoSeguro,?ThisForm.Tstextbox1.value, '0001',?Monto,?ThisForm.Idproducto1.Value, ?ThisForm.Producto.value","cResult")
			thisform.imprimir(cResult.IdFactura)
		ENDSCAN
		
		
		*!*	Create  Proc [dbo].[sas_FacturaServicio]
		*!*	(@IdEmpresa char(3), @IdCliente char(10),@Fecha datetime, @Usuario char(10), @Importe money, 
		*!*	@IdProducto char(20))
		
		
	ENDPROC

ENDDEFINE
